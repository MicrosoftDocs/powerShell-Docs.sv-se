---
ms.date: 06/11/2020
keywords: powershell,cmdlet
title: Säkerhets aspekter för PowerShell-fjärrkommunikation med WinRM
description: Det här dokumentet beskriver säkerhets problem, rekommendationer och bästa praxis när du använder PowerShell-fjärrkommunikation.
ms.openlocfilehash: 48167bd297905883b3d75caf9a07d06e6a9fc467
ms.sourcegitcommit: 9080316e3ca4f11d83067b41351531672b667b7a
ms.translationtype: MT
ms.contentlocale: sv-SE
ms.lasthandoff: 10/24/2020
ms.locfileid: "92501481"
---
# <a name="security-considerations-for-powershell-remoting-using-winrm"></a><span data-ttu-id="9e44f-104">Säkerhets aspekter för PowerShell-fjärrkommunikation med WinRM</span><span class="sxs-lookup"><span data-stu-id="9e44f-104">Security Considerations for PowerShell Remoting using WinRM</span></span>

<span data-ttu-id="9e44f-105">PowerShell-fjärrkommunikation är det rekommenderade sättet att hantera Windows-system.</span><span class="sxs-lookup"><span data-stu-id="9e44f-105">PowerShell Remoting is the recommended way to manage Windows systems.</span></span> <span data-ttu-id="9e44f-106">PowerShell-fjärrkommunikation är aktiverat som standard i Windows Server 2012 R2.</span><span class="sxs-lookup"><span data-stu-id="9e44f-106">PowerShell Remoting is enabled by default in Windows Server 2012 R2.</span></span> <span data-ttu-id="9e44f-107">Det här dokumentet beskriver säkerhets problem, rekommendationer och bästa praxis när du använder PowerShell-fjärrkommunikation.</span><span class="sxs-lookup"><span data-stu-id="9e44f-107">This document covers security concerns, recommendations, and best practices when using PowerShell Remoting.</span></span>

## <a name="what-is-powershell-remoting"></a><span data-ttu-id="9e44f-108">Vad är PowerShell-fjärrkommunikation?</span><span class="sxs-lookup"><span data-stu-id="9e44f-108">What is PowerShell Remoting?</span></span>

<span data-ttu-id="9e44f-109">PowerShell-fjärrkommunikation använder [Windows Remote Management (WinRM)](/windows/win32/winrm/portal), som är Microsofts implementering av protokollet [WS-Management (Web Services for Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) , så att användarna kan köra PowerShell-kommandon på fjärrdatorer.</span><span class="sxs-lookup"><span data-stu-id="9e44f-109">PowerShell Remoting uses [Windows Remote Management (WinRM)](/windows/win32/winrm/portal), which is the Microsoft implementation of the [Web Services for Management (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocol, to allow users to run PowerShell commands on remote computers.</span></span> <span data-ttu-id="9e44f-110">Du hittar mer information om hur du använder PowerShell-fjärrkommunikation vid [körning av fjärrkommandon](running-remote-commands.md).</span><span class="sxs-lookup"><span data-stu-id="9e44f-110">You can find more information about using PowerShell Remoting at [Running Remote Commands](running-remote-commands.md).</span></span>

<span data-ttu-id="9e44f-111">PowerShell-fjärrkommunikation är inte detsamma som att använda parametern **computername** för en cmdlet för att köra den på en fjärrdator, som använder RPC (Remote Procedure Call) som sitt underliggande protokoll.</span><span class="sxs-lookup"><span data-stu-id="9e44f-111">PowerShell Remoting is not the same as using the **ComputerName** parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC) as its underlying protocol.</span></span>

## <a name="powershell-remoting-default-settings"></a><span data-ttu-id="9e44f-112">Standardinställningar för PowerShell-fjärrkommunikation</span><span class="sxs-lookup"><span data-stu-id="9e44f-112">PowerShell Remoting default settings</span></span>

<span data-ttu-id="9e44f-113">PowerShell-fjärrkommunikation (och WinRM) lyssnar på följande portar:</span><span class="sxs-lookup"><span data-stu-id="9e44f-113">PowerShell Remoting (and WinRM) listen on the following ports:</span></span>

- <span data-ttu-id="9e44f-114">HTTP: 5985</span><span class="sxs-lookup"><span data-stu-id="9e44f-114">HTTP: 5985</span></span>
- <span data-ttu-id="9e44f-115">HTTPS: 5986</span><span class="sxs-lookup"><span data-stu-id="9e44f-115">HTTPS: 5986</span></span>

<span data-ttu-id="9e44f-116">Som standard tillåter PowerShell-fjärrkommunikation endast anslutningar från medlemmar i gruppen Administratörer.</span><span class="sxs-lookup"><span data-stu-id="9e44f-116">By default, PowerShell Remoting only allows connections from members of the Administrators group.</span></span>
<span data-ttu-id="9e44f-117">Sessioner startas under användarens kontext, så alla åtkomst kontroller för operativ system som tillämpas på enskilda användare och grupper fortsätter att gälla för dem när de är anslutna via PowerShell-fjärrkommunikation.</span><span class="sxs-lookup"><span data-stu-id="9e44f-117">Sessions are launched under the user's context, so all operating system access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.</span></span>

<span data-ttu-id="9e44f-118">I privata nätverk godkänner standard regeln för Windows-brandväggen för PowerShell-fjärrkommunikation alla anslutningar.</span><span class="sxs-lookup"><span data-stu-id="9e44f-118">On private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections.</span></span> <span data-ttu-id="9e44f-119">I offentliga nätverk tillåter Windows-Standardregeln PowerShell fjärr anslutningar endast från samma undernät.</span><span class="sxs-lookup"><span data-stu-id="9e44f-119">On public networks, the default Windows Firewall rule allows PowerShell Remoting connections only from within the same subnet.</span></span> <span data-ttu-id="9e44f-120">Du måste uttryckligen ändra regeln för att öppna PowerShell-fjärrkommunikationer för alla anslutningar i ett offentligt nätverk.</span><span class="sxs-lookup"><span data-stu-id="9e44f-120">You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.</span></span>

> [!Warning]
> <span data-ttu-id="9e44f-121">Brand Väggs regeln för offentliga nätverk är avsedd att skydda datorn från potentiellt skadliga externa anslutnings försök.</span><span class="sxs-lookup"><span data-stu-id="9e44f-121">The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts.</span></span> <span data-ttu-id="9e44f-122">Var försiktig när du tar bort den här regeln.</span><span class="sxs-lookup"><span data-stu-id="9e44f-122">Use caution when removing this rule.</span></span>

## <a name="process-isolation"></a><span data-ttu-id="9e44f-123">Process isolering</span><span class="sxs-lookup"><span data-stu-id="9e44f-123">Process isolation</span></span>

<span data-ttu-id="9e44f-124">PowerShell-fjärrkommunikation använder WinRM för kommunikation mellan datorer.</span><span class="sxs-lookup"><span data-stu-id="9e44f-124">PowerShell Remoting uses WinRM for communication between computers.</span></span> <span data-ttu-id="9e44f-125">WinRM körs som en tjänst under nätverks tjänst kontot och skapar isolerade processer som körs som användar konton som värdar för PowerShell-instanser.</span><span class="sxs-lookup"><span data-stu-id="9e44f-125">WinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances.</span></span> <span data-ttu-id="9e44f-126">En instans av PowerShell som körs som en användare har ingen åtkomst till en process som kör en instans av PowerShell som en annan användare.</span><span class="sxs-lookup"><span data-stu-id="9e44f-126">An instance of PowerShell running as one user has no access to a process running an instance of PowerShell as another user.</span></span>

## <a name="event-logs-generated-by-powershell-remoting"></a><span data-ttu-id="9e44f-127">Händelse loggar som genererats av PowerShell-fjärrkommunikation</span><span class="sxs-lookup"><span data-stu-id="9e44f-127">Event logs generated by PowerShell Remoting</span></span>

<span data-ttu-id="9e44f-128">FireEye har fått en klar Sammanfattning av händelse loggarna och andra säkerhets fakta som skapats av PowerShell-fjärrsessioner, tillgängliga vid utvärdering av [PowerShell-attacker](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span><span class="sxs-lookup"><span data-stu-id="9e44f-128">FireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span></span>

## <a name="encryption-and-transport-protocols"></a><span data-ttu-id="9e44f-129">Krypterings-och transport protokoll</span><span class="sxs-lookup"><span data-stu-id="9e44f-129">Encryption and transport protocols</span></span>

<span data-ttu-id="9e44f-130">Det är bra att överväga säkerheten hos en PowerShell-fjärranslutning från två perspektiv: inledande autentisering och pågående kommunikation.</span><span class="sxs-lookup"><span data-stu-id="9e44f-130">It is helpful to consider the security of a PowerShell Remoting connection from two perspectives: initial authentication, and ongoing communication.</span></span>

<span data-ttu-id="9e44f-131">Oavsett vilket transport protokoll som används (HTTP eller HTTPS) krypterar WinRM alltid all PowerShell Remoting-kommunikation efter den första autentiseringen.</span><span class="sxs-lookup"><span data-stu-id="9e44f-131">Regardless of the transport protocol used (HTTP or HTTPS), WinRM always encrypts all PowerShell remoting communication after initial authentication.</span></span>

### <a name="initial-authentication"></a><span data-ttu-id="9e44f-132">Inledande autentisering</span><span class="sxs-lookup"><span data-stu-id="9e44f-132">Initial authentication</span></span>

<span data-ttu-id="9e44f-133">Autentiseringen bekräftar identiteten för klienten till servern – och helst-servern till klienten.</span><span class="sxs-lookup"><span data-stu-id="9e44f-133">Authentication confirms the identity of the client to the server - and ideally - the server to the client.</span></span>

<span data-ttu-id="9e44f-134">När en klient ansluter till en domän server med hjälp av dator namnet är standardautentiseringsprotokollet [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span><span class="sxs-lookup"><span data-stu-id="9e44f-134">When a client connects to a domain server using its computer name, the default authentication protocol is [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span></span> <span data-ttu-id="9e44f-135">Kerberos garanterar både användarens identitet och Server identitet utan att skicka några sorters återanvändbara autentiseringsuppgifter.</span><span class="sxs-lookup"><span data-stu-id="9e44f-135">Kerberos guarantees both the user identity and server identity without sending any sort of reusable credential.</span></span>

<span data-ttu-id="9e44f-136">När en klient ansluter till en domän server med dess IP-adress, eller ansluter till en arbets grupps Server, är Kerberos-autentisering inte möjlig.</span><span class="sxs-lookup"><span data-stu-id="9e44f-136">When a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible.</span></span> <span data-ttu-id="9e44f-137">I så fall använder PowerShell-fjärrkommunikationer autentiseringsprotokollet [NTLM-autentisering](/windows/win32/secauthn/microsoft-ntlm).</span><span class="sxs-lookup"><span data-stu-id="9e44f-137">In that case, PowerShell Remoting relies on the [NTLM authentication protocol](/windows/win32/secauthn/microsoft-ntlm).</span></span> <span data-ttu-id="9e44f-138">NTLM-autentiseringsprotokollet garanterar användar identiteten utan att skicka någon sorts kan delegeras-autentiseringsuppgift.</span><span class="sxs-lookup"><span data-stu-id="9e44f-138">The NTLM authentication protocol guarantees the user identity without sending any sort of delegable credential.</span></span> <span data-ttu-id="9e44f-139">För att bevisa användar identitet kräver NTLM-protokollet att både klienten och servern beräknar en sessionsnyckel från användarens lösen ord utan att behöva utväxla själva lösen ordet.</span><span class="sxs-lookup"><span data-stu-id="9e44f-139">To prove user identity, the NTLM protocol requires that both the client and server compute a session key from the user's password without ever exchanging the password itself.</span></span> <span data-ttu-id="9e44f-140">Servern känner vanligt vis inte till användarens lösen ord, så den kommunicerar med domänkontrollanten, som känner till användarens lösen ord och beräknar sessionsnyckeln för servern.</span><span class="sxs-lookup"><span data-stu-id="9e44f-140">The server typically does not know the user's password, so it communicates with the domain controller, which does know the user's password and calculates the session key for the server.</span></span>

<span data-ttu-id="9e44f-141">NTLM-protokollet garanterar dock inte Server identiteten.</span><span class="sxs-lookup"><span data-stu-id="9e44f-141">The NTLM protocol does not, however, guarantee server identity.</span></span> <span data-ttu-id="9e44f-142">Precis som med alla protokoll som använder NTLM för autentisering kan en angripare med åtkomst till en domänansluten dators dator konto anropa domänkontrollanten för att beräkna en NTLM-sessionsnyckel och därmed imitera servern.</span><span class="sxs-lookup"><span data-stu-id="9e44f-142">As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine account could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.</span></span>

<span data-ttu-id="9e44f-143">NTLM-baserad autentisering är inaktiverat som standard, men kan tillåtas genom att antingen konfigurera SSL på mål servern eller genom att konfigurera inställningen för WinRM TrustedHosts på klienten.</span><span class="sxs-lookup"><span data-stu-id="9e44f-143">NTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting on the client.</span></span>

#### <a name="using-ssl-certificates-to-validate-server-identity-during-ntlm-based-connections"></a><span data-ttu-id="9e44f-144">Använda SSL-certifikat för att verifiera Server identitet under NTLM-baserade anslutningar</span><span class="sxs-lookup"><span data-stu-id="9e44f-144">Using SSL certificates to validate server identity during NTLM-based connections</span></span>

<span data-ttu-id="9e44f-145">Eftersom NTLM-autentiseringsprotokollet inte kan garantera identiteten för mål servern (bara att det redan känner till ditt lösen ord) kan du konfigurera mål servrar för att använda SSL för PowerShell-fjärrkommunikation.</span><span class="sxs-lookup"><span data-stu-id="9e44f-145">Since the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers to use SSL for PowerShell Remoting.</span></span>
<span data-ttu-id="9e44f-146">Att tilldela ett SSL-certifikat till mål servern (om det utfärdats av en certifikat utfärdare som klienten också litar på) aktiverar NTLM-baserad autentisering som garanterar både användar identitet och Server identitet.</span><span class="sxs-lookup"><span data-stu-id="9e44f-146">Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables NTLM-based authentication that guarantees both the user identity and server identity.</span></span>

#### <a name="ignoring-ntlm-based-server-identity-errors"></a><span data-ttu-id="9e44f-147">Ignorerar NTLM-baserade server identitets fel</span><span class="sxs-lookup"><span data-stu-id="9e44f-147">Ignoring NTLM-based server identity errors</span></span>

<span data-ttu-id="9e44f-148">Om det är omöjligt att distribuera ett SSL-certifikat till en server för NTLM-anslutningar kan du utelämna de resulterande identitets felen genom att lägga till servern i listan WinRM **TrustedHosts** .</span><span class="sxs-lookup"><span data-stu-id="9e44f-148">If deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM **TrustedHosts** list.</span></span> <span data-ttu-id="9e44f-149">Observera att om du lägger till ett server namn i listan **TrustedHosts** bör du inte anses som någon form av en instruktion av själva Värdarnas trovärdighet, eftersom NTLM-autentiseringsprotokollet inte kan garantera att du ansluter till den värd som du vill ansluta till.</span><span class="sxs-lookup"><span data-stu-id="9e44f-149">Please note that adding a server name to the **TrustedHosts** list should not be considered as any form of statement of the trustworthiness of the hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.</span></span> <span data-ttu-id="9e44f-150">I stället bör du se till att inställningen TrustedHosts är listan över värdar för vilka du vill förhindra att det fel som genereras av inte kan verifiera serverns identitet.</span><span class="sxs-lookup"><span data-stu-id="9e44f-150">Instead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.</span></span>

### <a name="ongoing-communication"></a><span data-ttu-id="9e44f-151">Pågående kommunikation</span><span class="sxs-lookup"><span data-stu-id="9e44f-151">Ongoing Communication</span></span>

<span data-ttu-id="9e44f-152">När den inledande autentiseringen är klar krypterar WinRM den pågående kommunikationen.</span><span class="sxs-lookup"><span data-stu-id="9e44f-152">Once initial authentication is complete, the WinRM encrypts the ongoing communication.</span></span> <span data-ttu-id="9e44f-153">När du ansluter via HTTPS används TLS-protokollet för att förhandla den kryptering som används för att transportera data.</span><span class="sxs-lookup"><span data-stu-id="9e44f-153">When connecting over HTTPS, the TLS protocol is used to negotiate the encryption used to transport data.</span></span>
<span data-ttu-id="9e44f-154">När du ansluter via HTTP avgörs kryptering på meddelande nivå av det första autentiseringsprotokoll som används.</span><span class="sxs-lookup"><span data-stu-id="9e44f-154">When connecting over HTTP, message-level encryption is determined by initial authentication protocol used.</span></span>

- <span data-ttu-id="9e44f-155">Grundläggande autentisering ger ingen kryptering.</span><span class="sxs-lookup"><span data-stu-id="9e44f-155">Basic authentication provide no encryption.</span></span>
- <span data-ttu-id="9e44f-156">NTLM-autentisering använder en RC4-chiffer med en 128-bitars nyckel.</span><span class="sxs-lookup"><span data-stu-id="9e44f-156">NTLM authentication uses an RC4 cipher with a 128-bit key.</span></span>
- <span data-ttu-id="9e44f-157">Kryptering av Kerberos-autentisering bestäms av `etype` i TGS-biljetten.</span><span class="sxs-lookup"><span data-stu-id="9e44f-157">Kerberos authentication encryption is determined by the `etype` in the TGS ticket.</span></span> <span data-ttu-id="9e44f-158">Detta är AES-256 på moderna system.</span><span class="sxs-lookup"><span data-stu-id="9e44f-158">This is AES-256 on modern systems.</span></span>
- <span data-ttu-id="9e44f-159">CredSSP-kryptering använder TLS-chiffrering som förhandlats i hand skakningen.</span><span class="sxs-lookup"><span data-stu-id="9e44f-159">CredSSP encryption is uses the TLS cipher suite that was negotiated in the handshake.</span></span>

## <a name="making-the-second-hop"></a><span data-ttu-id="9e44f-160">Gör det andra hoppet</span><span class="sxs-lookup"><span data-stu-id="9e44f-160">Making the second hop</span></span>

<span data-ttu-id="9e44f-161">Som standard använder PowerShell-fjärrkommunikation Kerberos (om det är tillgängligt) eller NTLM för autentisering.</span><span class="sxs-lookup"><span data-stu-id="9e44f-161">By default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication.</span></span> <span data-ttu-id="9e44f-162">Båda protokollen autentiserar sig på fjärrdatorn utan att skicka autentiseringsuppgifter till den.</span><span class="sxs-lookup"><span data-stu-id="9e44f-162">Both of these protocols authenticate to the remote machine without sending credentials to it.</span></span> <span data-ttu-id="9e44f-163">Det här är det säkraste sättet att autentisera, men eftersom fjärrdatorn inte har användarens autentiseringsuppgifter kan den inte komma åt andra datorer och tjänster för användarens räkning.</span><span class="sxs-lookup"><span data-stu-id="9e44f-163">This is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf.</span></span> <span data-ttu-id="9e44f-164">Detta kallas "andra hopp problemet".</span><span class="sxs-lookup"><span data-stu-id="9e44f-164">This is known as the "second hop problem".</span></span>

<span data-ttu-id="9e44f-165">Det finns flera sätt att undvika det här problemet.</span><span class="sxs-lookup"><span data-stu-id="9e44f-165">There are several ways to avoid this problem.</span></span> <span data-ttu-id="9e44f-166">För beskrivningar av dessa metoder och för-och nack delar med varandra, se [göra det andra hoppet i PowerShell-fjärrkommunikation](PS-remoting-second-hop.md).</span><span class="sxs-lookup"><span data-stu-id="9e44f-166">For descriptions of these methods, and the pros and cons of each, see [Making the second hop in PowerShell Remoting](PS-remoting-second-hop.md).</span></span>

## <a name="references"></a><span data-ttu-id="9e44f-167">Referenser</span><span class="sxs-lookup"><span data-stu-id="9e44f-167">References</span></span>

- [<span data-ttu-id="9e44f-168">Windows Remote Management (WinRM)</span><span class="sxs-lookup"><span data-stu-id="9e44f-168">Windows Remote Management (WinRM)</span></span>](/windows/win32/winrm/portal)
- [<span data-ttu-id="9e44f-169">WS-Management (Web Services for Management)</span><span class="sxs-lookup"><span data-stu-id="9e44f-169">Web Services for Management (WS-Management)</span></span>](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf)
- [<span data-ttu-id="9e44f-170">2.2.9.1 krypterade meddelande typer</span><span class="sxs-lookup"><span data-stu-id="9e44f-170">2.2.9.1 Encrypted Message Types</span></span>](/openspecs/windows_protocols/ms-wsmv/58421aa4-861a-4410-831a-c999f094cdb7)
- [<span data-ttu-id="9e44f-171">Kerberos</span><span class="sxs-lookup"><span data-stu-id="9e44f-171">Kerberos</span></span>](/windows/win32/secauthn/microsoft-kerberos)
- [<span data-ttu-id="9e44f-172">NTLM-autentiseringsprotokoll</span><span class="sxs-lookup"><span data-stu-id="9e44f-172">NTLM authentication protocol</span></span>](/windows/win32/secauthn/microsoft-ntlm)
- [<span data-ttu-id="9e44f-173">Undersöka PowerShell-attacker</span><span class="sxs-lookup"><span data-stu-id="9e44f-173">Investigating PowerShell Attacks</span></span>](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf)
